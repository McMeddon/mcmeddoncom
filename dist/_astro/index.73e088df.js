const it=`
`,q="	",W="=",v='"',U=" ",k="[",j="]",I="/",Y="\\",Q=t=>typeof t=="object"&&!!t.tag,Lt=t=>typeof t=="string",Ot=(t,e,n)=>Object.keys(t).reduce(e,n),mt=t=>Q(t)?t.content.reduce((e,n)=>e+mt(n),0):Lt(t)?t.length:0,Qt=(t,e)=>{t.content.push(e)},Et=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/(javascript|data|vbscript):/gi,"$1%3A"),xt=(t,e)=>{const n=typeof e,s={boolean:()=>e?`${t}`:"",number:()=>`${t}="${e}"`,string:()=>`${t}="${Et(e)}"`,object:()=>`${t}="${Et(JSON.stringify(e))}"`};return s[n]?s[n]():""},J=t=>t==null?"":Ot(t,(e,n)=>[...e,xt(n,t[n])],[""]).join(" "),X=t=>Ot(t,(e,n)=>t[n]===n?t[n]:null,null),Jt=(t,e)=>{const n=X(e);if(n){const s=xt(t,n),i={...e};delete i[n];const u=J(i);return`${s}${u}`}return`${t}${J(e)}`};class G{attr(e,n){return typeof n<"u"&&(this.attrs[e]=n),this.attrs[e]}append(e){return Qt(this,e)}get length(){return mt(this)}toTagStart({openTag:e=k,closeTag:n=j}={}){const s=Jt(this.tag,this.attrs);return`${e}${s}${n}`}toTagEnd({openTag:e=k,closeTag:n=j}={}){return`${e}${I}${this.tag}${n}`}toTagNode(){return new G(this.tag.toLowerCase(),this.attrs,this.content)}toString({openTag:e=k,closeTag:n=j}={}){const s=this.content.length===0,i=this.content.reduce((c,O)=>c+O.toString({openTag:e,closeTag:n}),""),u=this.toTagStart({openTag:e,closeTag:n});return s?u:`${u}${i}${this.toTagEnd({openTag:e,closeTag:n})}`}constructor(e,n,s){this.tag=e,this.attrs=n,this.content=Array.isArray(s)?s:[s]}}G.create=(t,e={},n=[])=>new G(t,e,n);G.isOf=(t,e)=>t.tag===e;const L="type",ct="value",Ct="row",Rt="line",wt=1,Wt=2,Gt=3,$t=4,Pt=5,Dt=6,tt=t=>t&&typeof t[ct]<"u"?t[ct]:"",Xt=t=>t&&t[Rt]||0,Zt=t=>t&&t[Ct]||0,te=t=>t&&typeof t[L]<"u"?t[L]===Pt||t[L]===Dt||t[L]===wt:!1,ee=t=>t&&typeof t[L]<"u"?t[L]===Wt:!1,ut=t=>tt(t).charCodeAt(0)===I.charCodeAt(0),ne=t=>!ut(t),se=t=>t&&typeof t[L]<"u"?t[L]===Gt:!1,re=t=>t&&typeof t[L]<"u"?t[L]===$t:!1,oe=t=>{const e=tt(t);return ut(t)?e.slice(1):e},ie=t=>{let e=k;return e+=tt(t),e+=j,e};class ce{isEmpty(){return isNaN(this[L])}isText(){return te(this)}isTag(){return ee(this)}isAttrName(){return se(this)}isAttrValue(){return re(this)}isStart(){return ne(this)}isEnd(){return ut(this)}getName(){return oe(this)}getValue(){return tt(this)}getLine(){return Xt(this)}getColumn(){return Zt(this)}toString(){return ie(this)}constructor(e,n,s,i){this[L]=Number(e),this[ct]=String(n),this[Rt]=Number(s),this[Ct]=Number(i)}}const V=wt,pt=Wt,ae=Gt,dt=$t,ue=Pt,Te=Dt;function le(t,e){const n={pos:0,len:t.length},s=l=>{const{pos:h}=n,g=t.indexOf(l,h);return g>=0?t.substring(h,g):""},i=l=>t.indexOf(l,n.pos)>=0,u=()=>n.len>n.pos,c=()=>n.pos===n.len,O=(l=1,h)=>{n.pos+=l,e&&e.onSkip&&!h&&e.onSkip()},f=()=>t.substring(n.pos),d=(l=0)=>t.substring(n.pos,n.pos+l),_=()=>t[n.pos],C=()=>{const l=n.pos-1;return typeof t[l]<"u"?t[l]:null},R=()=>{const l=n.pos+1;return l<=t.length-1?t[l]:null},m=(l,h)=>{let g=0;if(u())for(g=n.pos;u()&&l(_());)O(1,h);return t.substring(g,n.pos)};this.skip=O,this.hasNext=u,this.getCurr=_,this.getRest=f,this.getNext=R,this.getPrev=C,this.isLast=c,this.includes=i,this.grabWhile=m,this.grabN=d,this.substrUntilChar=s}const _t=(t,e)=>new le(t,e),fe=(t,e)=>{for(;t.charAt(0)===e;)t=t.substring(1);for(;t.charAt(t.length-1)===e;)t=t.substring(0,t.length-1);return t},ge=t=>t.replace(Y+v,v);function Ae(t=[]){const e=t,n=()=>Array.isArray(e)&&e.length>0&&typeof e[e.length-1]<"u"?e[e.length-1]:null,s=()=>e.length?e.pop():!1,i=c=>e.push(c),u=()=>e;this.push=i,this.toArray=u,this.getLast=n,this.flushLast=s}const z=(t=[])=>new Ae(t),he="!",Ee=(t,e,n=0,s=0)=>new ce(t,e,n,s);function pe(t,e={}){let f=0,d=0,_=-1,C=0,R=0,m="";const l=new Array(Math.floor(t.length)),h=e.openTag||k,g=e.closeTag||j,et=!!e.enableEscapeTags,nt=e.contextFreeTags||[],st=e.onToken||(()=>{}),rt=[g,h,v,Y,U,q,W,it,he],ot=[h,U,q,it],r=[U,q],T=[W,U,q],p=o=>rt.indexOf(o)>=0,P=o=>o===it,S=o=>r.indexOf(o)>=0,Tt=o=>ot.indexOf(o)===-1,Vt=o=>T.indexOf(o)>=0,It=o=>o===h||o===g||o===Y,lt=o=>o===Y,ft=()=>{d++},gt=o=>ge(fe(o,v)),At=(o,A)=>{m!==""&&A&&(m=""),m===""&&nt.includes(o)&&(m=o)},a=_t(t,{onSkip:ft});function N(o,A){const E=Ee(o,A,f,d);st(E),_+=1,l[_]=E}function kt(o,A){if(R===1){const b=H=>!(H===W||S(H)),$=o.grabWhile(b),D=o.isLast(),M=o.getCurr()!==W;return o.skip(),D||M?N(dt,gt($)):N(ae,$),D?0:M?1:2}if(R===2){let b=!1;const $=M=>{const H=M===v,vt=o.getPrev(),ht=o.getNext(),Ht=vt===Y,qt=ht===W,zt=S(M),Bt=S(ht);return b&&Vt(M)?!0:H&&!Ht&&(b=!b,!b&&!(qt||Bt))?!1:A?!0:zt===!1},D=o.grabWhile($);return o.skip(),N(dt,gt(D)),o.isLast()?0:1}const E=b=>!(b===W||S(b)||o.isLast()),y=o.grabWhile(E);return N(pt,y),At(y),o.skip(),A?2:o.includes(W)?1:2}function jt(){const o=a.getCurr(),A=a.getNext();a.skip();const E=a.substrUntilChar(g),y=E.length===0||E.indexOf(h)>=0;if(p(A)||y||a.isLast())return N(V,o),0;const w=E.indexOf(W)===-1,b=E[0]===I;if(w||b){const $=a.grabWhile(D=>D!==g);return a.skip(),N(pt,$),At($,b),0}return 2}function Kt(){const A=a.grabWhile(w=>w!==g,!0),E=_t(A,{onSkip:ft}),y=E.includes(U);for(R=0;E.hasNext();)R=kt(E,!y);return a.skip(),0}function Ut(){if(P(a.getCurr()))return N(Te,a.getCurr()),a.skip(),d=0,f++,0;if(S(a.getCurr())){const A=a.grabWhile(S);return N(ue,A),0}if(a.getCurr()===h){if(m){const A=h.length+I.length+m.length,E=`${h}${I}${m}`;if(a.grabN(A)===E)return 1}else if(a.includes(g))return 1;return N(V,a.getCurr()),a.skip(),0}if(et){if(lt(a.getCurr())){const y=a.getCurr(),w=a.getNext();return a.skip(),It(w)?(a.skip(),N(V,w),0):(N(V,y),0)}const A=y=>Tt(y)&&!lt(y),E=a.grabWhile(A);return N(V,E),0}const o=a.grabWhile(Tt);return N(V,o),0}function Ft(){for(C=0;a.hasNext();)switch(C){case 1:C=jt();break;case 2:C=Kt();break;case 0:default:C=Ut();break}return l.length=_+1,l}function Yt(o){const A=h+I+o.getValue();return t.indexOf(A)>-1}return{tokenize:Ft,isTokenNested:Yt}}const de=(t,e={})=>{const n=e,s=n.openTag||k,i=n.closeTag||j;let u=null;const c=z(),O=z(),f=z(),d=z(),_=new Set,C=r=>{const T=r.getValue();return!_.has(T)&&u.isTokenNested&&u.isTokenNested(r)?(_.add(T),!0):_.has(T)},R=r=>!!_.has(r),m=r=>n.onlyAllowTags&&n.onlyAllowTags.length?n.onlyAllowTags.indexOf(r)>=0:!0,l=()=>{f.flushLast()&&d.flushLast()},h=()=>{const r=O.getLast();return r&&Array.isArray(r.content)?r.content:c.toArray()},g=r=>{const T=h();Array.isArray(T)&&(Q(r)?m(r.tag)?T.push(r.toTagNode()):(T.push(r.toTagStart({openTag:s,closeTag:i})),r.content.length&&(r.content.forEach(p=>{T.push(p)}),T.push(r.toTagEnd({openTag:s,closeTag:i})))):T.push(r))},et=r=>{l();const T=G.create(r.getValue()),p=C(r);f.push(T),p?O.push(T):g(T)},nt=r=>{l();const T=O.flushLast();if(T)g(T);else if(typeof n.onError=="function"){const p=r.getValue(),P=r.getLine(),S=r.getColumn();n.onError({message:`Inconsistent tag '${p}' on line ${P} and column ${S}`,tagName:p,lineNumber:P,columnNumber:S})}},st=r=>{r.isStart()&&et(r),r.isEnd()&&nt(r)},rt=r=>{const T=f.getLast(),p=r.getValue(),P=R(r);if(T)if(r.isAttrName())d.push(p),T.attr(d.getLast(),"");else if(r.isAttrValue()){const S=d.getLast();S?(T.attr(S,p),d.flushLast()):T.attr(p,p)}else r.isText()?P?T.append(p):g(p):r.isTag()&&g(r.toString());else r.isText()?g(p):r.isTag()&&g(r.toString())},ot=r=>{r.isTag()?st(r):rt(r)};return u=(e.createTokenizer?e.createTokenizer:pe)(t,{onToken:ot,openTag:s,closeTag:i,onlyAllowTags:n.onlyAllowTags,contextFreeTags:n.contextFreeTags,enableEscapeTags:n.enableEscapeTags}),u.tokenize(),c.toArray()},at=t=>typeof t=="object",_e=t=>typeof t=="boolean";function K(t,e){const n=t;if(Array.isArray(n))for(let s=0;s<n.length;s++)n[s]=K(e(n[s]),e);else n&&at(n)&&n.content&&K(n.content,e);return n}function Z(t,e){return typeof t!=typeof e?!1:!at(t)||t===null?t===e:Array.isArray(t)?t.every(n=>[].some.call(e,s=>Z(n,s))):Object.keys(t).every(n=>{const s=e[n],i=t[n];return at(i)&&i!==null&&s!==null?Z(i,s):_e(i)?i!==(s===null):s===i})}function Nt(t,e){return Array.isArray(t)?K(this,n=>{for(let s=0;s<t.length;s++)if(Z(t[s],n))return e(n);return n}):K(this,n=>Z(t,n)?e(n):n)}function Ne(t){return K(this,t)}function Se(t){const e=typeof t=="function"?[t]:t||[];let n={skipParse:!1};return{process(s,i){n=i||{};const u=n.parser||de,c=n.render,O=n.data||null;if(typeof u!="function")throw new Error('"parser" is not a function, please pass to "process(input, { parser })" right function');let f=n.skipParse?s||[]:u(s,n);const d=f;return f.messages=[],f.options=n,f.walk=Ne,f.match=Nt,e.forEach(_=>{f=_(f,{parse:u,render:c,iterate:K,match:Nt,data:O})||f}),{get html(){if(typeof c!="function")throw new Error('"render" function not defined, please pass to "process(input, { render })"');return c(f,f.options)},tree:f,raw:d,messages:f.messages}}}}const ye="/>",be="</",St="<",yt=">",Le=(t,{stripTags:e=!1})=>{if(!t)return"";const n=typeof t;return n==="string"||n==="number"?t:n==="object"?e===!0?B(t.content,{stripTags:e}):t.content===null?[St,t.tag,J(t.attrs),ye].join(""):[St,t.tag,J(t.attrs),yt,B(t.content),be,t.tag,yt].join(""):Array.isArray(t)?B(t,{stripTags:e}):""},B=(t,{stripTags:e=!1}={})=>[].concat(t).reduce((n,s)=>n+Le(s,{stripTags:e}),""),Ge=(t,e,n)=>Se(e).process(t,{...n,render:B}).html,Oe=t=>typeof t=="object"&&!!t.tag;function me(t,e,n,s){e.walk(i=>Oe(i)&&t[i.tag]?t[i.tag](i,n,s):i)}function Mt(t,e=me){const n=(s={})=>{n.options=Object.assign(n.options||{},s);const i=(u,c)=>e(t,u,c,n.options);return i.options=n.options,i};return n.extend=s=>Mt(s(t,n.options),e),n}const xe=(t,e)=>t[0]===e,bt={color:t=>`color:${t};`,size:t=>`font-size:${t};`},Ce=t=>Object.keys(t).reduce((e,n)=>bt[n]?e.concat(bt[n](t[n])):e,[]).join(" "),Re=t=>{let e=0;const n=[],s=()=>G.create("li"),i=c=>{n[e]=n[e]||c},u=c=>{n[e]&&n[e].content?n[e].content=n[e].content.concat(c):n[e]=n[e].concat(c)};return t.forEach(c=>{Lt(c)&&xe(c,"*")?(n[e]&&e++,i(s()),u(c.substr(1))):Q(c)&&G.isOf(c,"*")?(n[e]&&e++,i(s())):Q(n[e])?n[e]?u(c):i(c):(e++,i(c))}),[].concat(n)},we=(t,e)=>X(t.attrs)?X(t.attrs):e(t.content),x=(t,e,n)=>({tag:t,attrs:e,content:n}),F=t=>({style:t}),We={b:t=>x("span",F("font-weight: bold;"),t.content),i:t=>x("span",F("font-style: italic;"),t.content),u:t=>x("span",F("text-decoration: underline;"),t.content),s:t=>x("span",F("text-decoration: line-through;"),t.content),url:(t,{render:e},n)=>x("a",{href:we(t,e)},t.content),img:(t,{render:e})=>x("img",{src:e(t.content)},null),quote:t=>x("blockquote",{},[x("p",{},t.content)]),code:t=>x("pre",{},t.content),style:t=>x("span",F(Ce(t.attrs)),t.content),list:t=>{const e=X(t.attrs);return x(e?"ol":"ul",e?{type:e}:{},Re(t.content))}},$e=Mt(We);export{$e as p,Ge as t};
