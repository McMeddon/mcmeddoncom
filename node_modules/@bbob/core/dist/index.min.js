!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).BbobCore={})}(this,function(t){"use strict";let e=t=>"object"==typeof t&&!!t.tag,r=t=>"string"==typeof t,n=(t,e,r)=>Object.keys(t).reduce(e,r),s=t=>e(t)?t.content.reduce((t,e)=>t+s(e),0):r(t)?t.length:0,i=(t,e)=>{t.content.push(e)},l=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/(javascript|data|vbscript):/gi,"$1%3A"),o=(t,e)=>{let r=typeof e,n={boolean:()=>e?""+t:"",number:()=>`${t}="${e}"`,string:()=>`${t}="${l(e)}"`,object:()=>`${t}="${l(JSON.stringify(e))}"`};return n[r]?n[r]():""},a=t=>null==t?"":n(t,(e,r)=>[...e,o(r,t[r])],[""]).join(" "),u=t=>n(t,(e,r)=>t[r]===r?t[r]:null,null),g=(t,e)=>{let r=u(e);if(r){let n=o(t,r),s={...e};delete s[r];let i=a(s);return`${n}${i}`}return`${t}${a(e)}`};class h{attr(t,e){return void 0!==e&&(this.attrs[t]=e),this.attrs[t]}append(t){return i(this,t)}get length(){return s(this)}toTagStart({openTag:t="[",closeTag:e="]"}={}){let r=g(this.tag,this.attrs);return`${t}${r}${e}`}toTagEnd({openTag:t="[",closeTag:e="]"}={}){return`${t}/${this.tag}${e}`}toTagNode(){return new h(this.tag.toLowerCase(),this.attrs,this.content)}toString({openTag:t="[",closeTag:e="]"}={}){let r=0===this.content.length,n=this.content.reduce((r,n)=>r+n.toString({openTag:t,closeTag:e}),""),s=this.toTagStart({openTag:t,closeTag:e});return r?s:`${s}${n}${this.toTagEnd({openTag:t,closeTag:e})}`}constructor(t,e,r){this.tag=t,this.attrs=e,this.content=Array.isArray(r)?r:[r]}}h.create=(t,e={},r=[])=>new h(t,e,r),h.isOf=(t,e)=>t.tag===e;let f="type",c="value",p="line",d=t=>t&&void 0!==t[c]?t[c]:"",y=t=>t&&t[p]||0,b=t=>t&&t.row||0,T=t=>!!t&&void 0!==t[f]&&(5===t[f]||6===t[f]||1===t[f]),A=t=>!!t&&void 0!==t[f]&&2===t[f],k=t=>47===d(t).charCodeAt(0),x=t=>!k(t),N=t=>!!t&&void 0!==t[f]&&3===t[f],m=t=>!!t&&void 0!==t[f]&&4===t[f],$=t=>{let e=d(t);return k(t)?e.slice(1):e},w=t=>d(t)+"]";class L{isEmpty(){return isNaN(this[f])}isText(){return T(this)}isTag(){return A(this)}isAttrName(){return N(this)}isAttrValue(){return m(this)}isStart(){return x(this)}isEnd(){return k(this)}getName(){return $(this)}getValue(){return d(this)}getLine(){return y(this)}getColumn(){return b(this)}toString(){return w(this)}constructor(t,e,r,n){this[f]=Number(t),this[c]=String(e),this[p]=Number(r),this.row=Number(n)}}function C(t,e){let r={pos:0,len:t.length},n=e=>{let{pos:n}=r,s=t.indexOf(e,n);return s>=0?t.substring(n,s):""},s=e=>t.indexOf(e,r.pos)>=0,i=()=>r.len>r.pos,l=(t=1,n)=>{r.pos+=t,e&&e.onSkip&&!n&&e.onSkip()},o=()=>t.substring(r.pos),a=(e=0)=>t.substring(r.pos,r.pos+e),u=()=>t[r.pos],g=()=>{let e=r.pos-1;return void 0!==t[e]?t[e]:null},h=()=>{let e=r.pos+1;return e<=t.length-1?t[e]:null},f=(e,n)=>{let s=0;if(i())for(s=r.pos;i()&&e(u());)l(1,n);return t.substring(s,r.pos)};this.skip=l,this.hasNext=i,this.getCurr=u,this.getRest=o,this.getNext=h,this.getPrev=g,this.isLast=()=>r.pos===r.len,this.includes=s,this.grabWhile=f,this.grabN=a,this.substrUntilChar=n}let v=(t,e)=>new C(t,e),E=(t,e)=>{for(;t.charAt(0)===e;)t=t.substring(1);for(;t.charAt(t.length-1)===e;)t=t.substring(0,t.length-1);return t},O=t=>t.replace('\\"','"');function S(t=[]){let e=()=>Array.isArray(t)&&t.length>0&&void 0!==t[t.length-1]?t[t.length-1]:null,r=()=>!!t.length&&t.pop(),n=e=>t.push(e);this.push=n,this.toArray=()=>t,this.getLast=e,this.flushLast=r}let j=(t=[])=>new S(t),W=(t,e,r=0,n=0)=>new L(t,e,r,n);function V(t,e={}){let r=0,n=0,s=-1,i=0,l=0,o="",a=Array(Math.floor(t.length)),u=e.openTag||"[",g=e.closeTag||"]",h=!!e.enableEscapeTags,f=e.contextFreeTags||[],c=e.onToken||(()=>{}),p=[g,u,'"',"\\"," ","	","=","\n","!"],d=[u," ","	","\n"],y=[" ","	"],b=["="," ","	"],T=t=>p.indexOf(t)>=0,A=t=>"\n"===t,k=t=>y.indexOf(t)>=0,x=t=>-1===d.indexOf(t),N=t=>b.indexOf(t)>=0,m=t=>t===u||t===g||"\\"===t,$=t=>"\\"===t,w=()=>{n++},L=t=>O(E(t,'"')),C=(t,e)=>{""!==o&&e&&(o=""),""===o&&f.includes(t)&&(o=t)},S=v(t,{onSkip:w});function j(t,e){let i=W(t,e,r,n);c(i),a[s+=1]=i}return{tokenize:function(){for(i=0;S.hasNext();)switch(i){case 1:i=function(){let t=S.getCurr(),e=S.getNext();S.skip();let r=S.substrUntilChar(g),n=0===r.length||r.indexOf(u)>=0;if(T(e)||n||S.isLast())return j(1,t),0;let s=-1===r.indexOf("="),i="/"===r[0];if(s||i){let l=S.grabWhile(t=>t!==g);return S.skip(),j(2,l),C(l,i),0}return 2}();break;case 2:i=function(){let t=S.grabWhile(t=>t!==g,!0),e=v(t,{onSkip:w}),r=e.includes(" ");for(l=0;e.hasNext();)l=function(t,e){if(1===l){let r=t=>!("="===t||k(t)),n=t.grabWhile(r),s=t.isLast(),i="="!==t.getCurr();return(t.skip(),s||i?j(4,L(n)):j(3,n),s)?0:i?1:2}if(2===l){let o=!1,a=r=>{let n=t.getPrev(),s=t.getNext(),i=k(r),l=k(s);return!!(o&&N(r))||('"'!==r||"\\"===n||!!(o=!o)||"="===s||!!l)&&(!!e||!1===i)},u=t.grabWhile(a);return(t.skip(),j(4,L(u)),t.isLast())?0:1}let g=e=>!("="===e||k(e)||t.isLast()),h=t.grabWhile(g);if(j(2,h),C(h),t.skip(),e)return 2;let f=t.includes("=");return f?1:2}(e,!r);return S.skip(),0}();break;default:i=function(){if(A(S.getCurr()))return j(6,S.getCurr()),S.skip(),n=0,r++,0;if(k(S.getCurr())){let t=S.grabWhile(k);return j(5,t),0}if(S.getCurr()===u){if(o){let e=u.length+1+o.length,s=`${u}/${o}`,i=S.grabN(e);if(i===s)return 1}else if(S.includes(g))return 1;return j(1,S.getCurr()),S.skip(),0}if(h){if($(S.getCurr())){let l=S.getCurr(),a=S.getNext();return(S.skip(),m(a))?(S.skip(),j(1,a),0):(j(1,l),0)}let f=t=>x(t)&&!$(t),c=S.grabWhile(f);return j(1,c),0}let p=S.grabWhile(x);return j(1,p),0}()}return a.length=s+1,a},isTokenNested:function(e){let r=u+"/"+e.getValue();return t.indexOf(r)>-1}}}let P=(t,r={})=>{let n=r.openTag||"[",s=r.closeTag||"]",i=null,l=j(),o=j(),a=j(),u=j(),g=new Set,f=t=>{let e=t.getValue();return!g.has(e)&&i.isTokenNested&&i.isTokenNested(t)?(g.add(e),!0):g.has(e)},c=t=>Boolean(g.has(t)),p=t=>!r.onlyAllowTags||!r.onlyAllowTags.length||r.onlyAllowTags.indexOf(t)>=0,d=()=>{a.flushLast()&&u.flushLast()},y=()=>{let t=o.getLast();return t&&Array.isArray(t.content)?t.content:l.toArray()},b=t=>{let r=y();Array.isArray(r)&&(e(t)?p(t.tag)?r.push(t.toTagNode()):(r.push(t.toTagStart({openTag:n,closeTag:s})),t.content.length&&(t.content.forEach(t=>{r.push(t)}),r.push(t.toTagEnd({openTag:n,closeTag:s})))):r.push(t))},T=t=>{d();let e=h.create(t.getValue()),r=f(t);a.push(e),r?o.push(e):b(e)},A=t=>{d();let e=o.flushLast();if(e)b(e);else if("function"==typeof r.onError){let n=t.getValue(),s=t.getLine(),i=t.getColumn();r.onError({message:`Inconsistent tag '${n}' on line ${s} and column ${i}`,tagName:n,lineNumber:s,columnNumber:i})}},k=t=>{t.isStart()&&T(t),t.isEnd()&&A(t)},x=t=>{let e=a.getLast(),r=t.getValue(),n=c(t);if(e){if(t.isAttrName())u.push(r),e.attr(u.getLast(),"");else if(t.isAttrValue()){let s=u.getLast();s?(e.attr(s,r),u.flushLast()):e.attr(r,r)}else t.isText()?n?e.append(r):b(r):t.isTag()&&b(t.toString())}else t.isText()?b(r):t.isTag()&&b(t.toString())},N=t=>{t.isTag()?k(t):x(t)};return(i=(r.createTokenizer?r.createTokenizer:V)(t,{onToken:N,openTag:n,closeTag:s,onlyAllowTags:r.onlyAllowTags,contextFreeTags:r.contextFreeTags,enableEscapeTags:r.enableEscapeTags})).tokenize(),l.toArray()},z=t=>"object"==typeof t,F=t=>"boolean"==typeof t;function B(t,e){let r=t;if(Array.isArray(r))for(let n=0;n<r.length;n++)r[n]=B(e(r[n]),e);else r&&z(r)&&r.content&&B(r.content,e);return r}function M(t,e){return typeof t==typeof e&&(z(t)&&null!==t?Array.isArray(t)?t.every(t=>[].some.call(e,e=>M(t,e))):Object.keys(t).every(r=>{let n=e[r],s=t[r];return z(s)&&null!==s&&null!==n?M(s,n):F(s)?s!==(null===n):n===s}):t===e)}function U(t,e){return Array.isArray(t)?B(this,r=>{for(let n=0;n<t.length;n++)if(M(t[n],r))return e(r);return r}):B(this,r=>M(t,r)?e(r):r)}function _(t){return B(this,t)}t.default=function(t){let e="function"==typeof t?[t]:t||[],r={skipParse:!1};return{process(t,n){r=n||{};let s=r.parser||P,i=r.render,l=r.data||null;if("function"!=typeof s)throw Error('"parser" is not a function, please pass to "process(input, { parser })" right function');let o=r.skipParse?t||[]:s(t,r),a=o;return o.messages=[],o.options=r,o.walk=_,o.match=U,e.forEach(t=>{o=t(o,{parse:s,render:i,iterate:B,match:U,data:l})||o}),{get html(){if("function"!=typeof i)throw Error('"render" function not defined, please pass to "process(input, { render })"');return i(o,o.options)},tree:o,raw:a,messages:o.messages}}}},Object.defineProperty(t,"__esModule",{value:!0})});
